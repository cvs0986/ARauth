openapi: 3.0.3
info:
  title: ARauth Identity IAM API
  description: |
    A headless Identity & Access Management (IAM) platform powered by ORY Hydra.
    Applications bring their own login UI, and the platform provides OAuth2/OIDC functionality.
  version: 0.1.0
  contact:
    name: ARauth Identity Team
    url: https://github.com/arauth-identity/iam
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://iam.example.com/api/v1
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Tenants
    description: Tenant management
  - name: Users
    description: User management
  - name: Authentication
    description: Authentication and login
  - name: MFA
    description: Multi-factor authentication
  - name: Roles
    description: Role management
  - name: Permissions
    description: Permission management

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the API
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: Kubernetes liveness probe endpoint
      operationId: livenessProbe
      responses:
        '200':
          description: Service is alive

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: Kubernetes readiness probe endpoint
      operationId: readinessProbe
      responses:
        '200':
          description: Service is ready
        '503':
          description: Service is not ready

  /tenants:
    post:
      tags:
        - Tenants
      summary: Create tenant
      description: Create a new tenant
      operationId: createTenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTenantRequest'
      responses:
        '201':
          description: Tenant created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '400':
          $ref: '#/components/responses/BadRequest'
    get:
      tags:
        - Tenants
      summary: List tenants
      description: List all tenants with optional filtering
      operationId: listTenants
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: List of tenants
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenants:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'
                  page:
                    type: integer
                  page_size:
                    type: integer

  /tenants/{id}:
    get:
      tags:
        - Tenants
      summary: Get tenant by ID
      operationId: getTenantById
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Tenant details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags:
        - Tenants
      summary: Update tenant
      operationId: updateTenant
      parameters:
        - $ref: '#/components/parameters/TenantId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTenantRequest'
      responses:
        '200':
          description: Tenant updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - Tenants
      summary: Delete tenant
      operationId: deleteTenant
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '200':
          description: Tenant deleted
        '404':
          $ref: '#/components/responses/NotFound'

  /users:
    post:
      tags:
        - Users
      summary: Create user
      description: Create a new user (requires tenant context)
      operationId: createUser
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
    get:
      tags:
        - Users
      summary: List users
      description: List users (requires tenant context)
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'

  /users/{id}:
    get:
      tags:
        - Users
      summary: Get user by ID
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login
      description: Authenticate user and initiate OAuth2 flow
      operationId: login
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /mfa/enroll:
    post:
      tags:
        - MFA
      summary: Enroll MFA
      description: Enroll user in MFA (TOTP)
      operationId: enrollMFA
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MFAEnrollRequest'
      responses:
        '200':
          description: MFA enrollment successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MFAEnrollResponse'

  /roles:
    post:
      tags:
        - Roles
      summary: Create role
      operationId: createRole
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '201':
          description: Role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
    get:
      tags:
        - Roles
      summary: List roles
      operationId: listRoles
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: List of roles

  /permissions:
    post:
      tags:
        - Permissions
      summary: Create permission
      operationId: createPermission
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePermissionRequest'
      responses:
        '201':
          description: Permission created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Permission'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    TenantHeader:
      name: X-Tenant-ID
      in: header
      required: true
      description: Tenant ID for multi-tenant operations
      schema:
        type: string
        format: uuid
    TenantId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    UserId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    Page:
      name: page
      in: query
      schema:
        type: integer
        default: 1
    PageSize:
      name: page_size
      in: query
      schema:
        type: integer
        default: 20
        maximum: 100

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: healthy
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: "0.1.0"
        checks:
          type: object
          additionalProperties:
            type: string

    Tenant:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        domain:
          type: string
        status:
          type: string
          enum: [active, inactive, suspended]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateTenantRequest:
      type: object
      required:
        - name
        - domain
      properties:
        name:
          type: string
        domain:
          type: string
        status:
          type: string
          enum: [active, inactive]

    UpdateTenantRequest:
      type: object
      properties:
        name:
          type: string
        domain:
          type: string
        status:
          type: string
          enum: [active, inactive, suspended]

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        username:
          type: string
        email:
          type: string
        first_name:
          type: string
        last_name:
          type: string
        status:
          type: string
          enum: [active, inactive, locked]
        mfa_enabled:
          type: boolean
        created_at:
          type: string
          format: date-time

    CreateUserRequest:
      type: object
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
        email:
          type: string
        password:
          type: string
          format: password
        first_name:
          type: string
        last_name:
          type: string

    LoginRequest:
      type: object
      required:
        - username
        - password
        - challenge
      properties:
        username:
          type: string
        password:
          type: string
          format: password
        challenge:
          type: string
          description: OAuth2 login challenge from Hydra

    LoginResponse:
      type: object
      properties:
        redirect_to:
          type: string
          format: uri

    MFAEnrollRequest:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          format: uuid

    MFAEnrollResponse:
      type: object
      properties:
        secret:
          type: string
        qr_code:
          type: string
        recovery_codes:
          type: array
          items:
            type: string

    Role:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        is_system:
          type: boolean

    CreateRoleRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
        is_system:
          type: boolean
          default: false

    Permission:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        name:
          type: string
        resource:
          type: string
        action:
          type: string

    CreatePermissionRequest:
      type: object
      required:
        - name
        - resource
        - action
      properties:
        name:
          type: string
        resource:
          type: string
        action:
          type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string

